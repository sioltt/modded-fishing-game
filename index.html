<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultimate Clicker Fishing Game - Moving Bar Minigame</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background-color: #f0f8ff; 
            margin: 0;
            color: #333;
        }

        #game-container {
            background: #fff;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            text-align: center;
            width: 90%;
            max-width: 500px;
            margin-bottom: 20px;
            display: none; /* Game content is hidden until login */
        }
        
        /* --- Login/Profile Styles (UNCHANGED) --- */
        #profile-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3000;
        }

        #profile-box {
            background: #fff;
            padding: 40px;
            border-radius: 10px;
            text-align: center;
            width: 90%;
            max-width: 350px;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.8);
        }

        #profile-box input {
            width: 100%;
            padding: 10px;
            margin: 8px 0 15px 0;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }

        #profile-box button {
            width: 100%;
            padding: 10px;
            margin-top: 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            color: white;
            transition: background-color 0.2s;
        }

        #login-button { background-color: #4CAF50; }
        #login-button:hover { background-color: #45a049; }

        #register-button { background-color: #007bff; }
        #register-button:hover { background-color: #0056b3; }
        
        #profile-message {
            margin-bottom: 15px;
            font-weight: bold;
            color: #dc3545;
        }


        /* --- Game Styles (UNCHANGED) --- */
        #fishing-button {
            padding: 15px 30px;
            font-size: 20px;
            cursor: pointer;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 8px;
            transition: background-color 0.3s, transform 0.1s;
        }

        #fishing-button:hover:not(:disabled) { background-color: #45a049; }
        #fishing-button:active:not(:disabled) { transform: scale(0.98); }
        #fishing-button:disabled { background-color: #9e9e9e; cursor: not-allowed; }

        #result { margin-top: 20px; font-size: 18px; min-height: 50px; }

        #inventory, #money-display, #current-rod, #current-map-display {
            margin-top: 15px; padding: 10px; border: 1px solid #ccc;
            border-radius: 8px; text-align: left; background: #fafafa;
        }
        
        #current-map-display { background-color: #c8e6c9; text-align: center; font-weight: bold; }
        #money-display { font-size: 1.2em; font-weight: bold; color: #2196F3; text-align: center; }
        #current-rod { font-size: 0.9em; text-align: center; background-color: #e0f7fa; }

        /* Rarity Classes (Simplified) */
        .rarity-common { color: #555; } .rarity-uncommon { color: #008000; }
        .rarity-rare { color: #0000ff; } .rarity-orange { color: #ff9900; } 
        .rarity-legendary { color: #800080; } .rarity-mythic { color: #ff8c00; }
        .rarity-exotic { color: #ffd700; } .rarity-secret { color: #ff69b4; }
        .rarity-apex { color: #dc143c; }
        
        .value-high { color: green; font-weight: bold; }
        .value-low { color: #cc0000; }

        /* Button Groups */
        #button-group, #save-load-group {
            display: flex; justify-content: center; margin-top: 15px;
            gap: 10px; flex-wrap: wrap;
        }
        
        .utility-button {
            padding: 8px 15px; font-size: 14px; cursor: pointer;
            background-color: #007bff; color: white; border: none;
            border-radius: 4px; transition: background-color 0.2s;
        }

        #sell-all-button { background-color: #dc3545; margin-top: 5px; width: 100%; }
        #sell-all-button:disabled { background-color: #9e9e9e; cursor: not-allowed; }
        
        #map-buttons-container { display: flex; justify-content: center; gap: 10px; margin-top: 10px; }
        .map-select-button { padding: 8px 12px; background-color: #5cb85c; }
        .map-select-button.active { background-color: #3b8b3b; box-shadow: 0 0 5px rgba(0, 0, 0, 0.5) inset; }
        .map-select-button:disabled { background-color: #9e9e9e; cursor: not-allowed; }

        /* Save/Load Group Styles */
        #save-load-group .utility-button:nth-child(1) { background-color: #ffc107; color: #333; } /* Save */
        #save-load-group .utility-button:nth-child(2) { background-color: #17a2b8; } /* Load */
        #save-load-group .utility-button:nth-child(3) { background-color: #dc3545; } /* Reset */

        /* --- Overlay Styles (Shop/Bestiary/Minigame) --- */
        .overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            /* Darken background for all overlays, except the login which has its own style */
            background-color: rgba(0, 0, 0, 0.8); 
            display: none;
            align-items: center; /* Center vertically */
            justify-content: center; /* Center horizontally */
            z-index: 2000;
        }

        .overlay-box {
            background: #fff; padding: 25px; border-radius: 10px;
            text-align: center; width: 90%; 
            max-width: 600px; /* Kept max-width for shop/bestiary boxes */
            box-shadow: 0 0 30px rgba(255, 255, 255, 0.8);
            max-height: 80vh; overflow-y: auto;
        }
        
        /* --- Moving Bar Minigame Styles: Centering and Dark Background --- */
        #minigame-overlay { 
            z-index: 3000; /* Ensure it's above other elements */
            background-color: rgba(0, 0, 0, 0.9); /* Darker background */
        }
        
        #minigame-box { 
            width: 300px; 
            max-width: 300px; /* Restrict minigame box width specifically */
        }

        #progress-bar-container {
            width: 250px; height: 20px; background-color: #eee;
            border-radius: 10px; margin: 15px auto; position: relative;
            border: 1px solid #aaa;
        }

        #progress-bar {
            height: 100%; width: 0%; background-color: #4CAF50;
            border-radius: 10px; transition: width 0.1s linear;
        }

        #target-area {
            position: absolute; height: 100%; background-color: rgba(255, 0, 0, 0.4);
            left: 50%; width: 20%; top: 0; border-left: 2px solid red;
            border-right: 2px solid red;
        }

        #minigame-button {
            padding: 10px 20px; font-size: 16px; cursor: pointer;
            background-color: #007bff; color: white; border: none;
            border-radius: 4px; margin-top: 10px;
        }
    </style>
</head>
<body onload="checkProfileOnLoad()">

<div id="profile-overlay">
    <div id="profile-box">
        <h3>üé£ Local Profile Login</h3>
        <p>Your game progress is saved locally to this profile.</p>
        
        <p id="profile-message" style="color: green;">Enter your details to Login or Register.</p>
        
        <label for="username-input">Username:</label>
        <input type="text" id="username-input" required placeholder="PlayerName" minlength="3">
        
        <label for="password-input">Password (local only):</label>
        <input type="password" id="password-input" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" minlength="4">
        
        <button id="login-button" onclick="handleLogin()">Login</button>
        <button id="register-button" onclick="handleRegister()">Register</button>
    </div>
</div>

<div id="game-container">
    <div style="font-size: 0.8em; text-align: right;">
        Logged in as: <strong><span id="current-profile-display"></span></strong> | 
        <button onclick="logoutProfile()" class="utility-button" style="background-color: #6c757d;">Logout</button>
    </div>
    <h2>üåä Ultimate Fishing Game üêü</h2>
    
    <div id="money-display">üí∞ Money: $0</div>
    
    <div id="current-rod">
        üé£ Current Rod: <span id="rod-name">Basic Rod</span> (Luck: <span id="rod-luck">0</span>, Catch Power Multiplier: <span id="rod-catch-power">1.00</span>)
    </div>
    
    <div id="current-map-display">
        üó∫Ô∏è Location: <span id="map-name">Lakeside Pier</span>
    </div>
    
    <div id="map-buttons-container">
        </div>

    <div id="button-group">
        <button id="fishing-button">Click to Fish!</button>
        <button id="shop-button" class="utility-button">üõí Open Shop</button>
        <button id="bestiary-button" class="utility-button">üìö Bestiary</button>
    </div>

    <div id="save-load-group">
        <button id="save-button" class="utility-button" onclick="saveGame()">üíæ Save</button>
        <button id="load-button" class="utility-button" onclick="loadGame(true)">üîÅ Reload Profile</button>
        <button id="reset-button" class="utility-button" onclick="resetGame()">üóëÔ∏è Reset Profile</button>
    </div>
    
    <div id="result">Waiting for a bite...</div>

    <div id="inventory">
        <h3>Inventory (Base Value)</h3>
        <ul id="fish-list">
            </ul>
        <button id="sell-all-button" disabled>Sell All Fish</button>
    </div>
</div>

<div id="shop-overlay" class="overlay">
    <div id="shop-box" class="overlay-box">
        <h3>üõí Fishing Rod Shop</h3>
        <p>Buy better rods to increase your **Luck** (better chance for rare fish) and **Catch Power** (a **higher multiplier** means each successful click adds more progress).</p>
        <div id="shop-items-list"></div>
        <button style="background-color: #6c757d;" onclick="closeShop()">Close Shop</button>
    </div>
</div>

<div id="minigame-overlay" class="overlay"> <div id="minigame-box" class="overlay-box" style="width: 300px; max-width: 300px;">
        <h3>Mini-Game: Reel it In!</h3>
        <p>Click the button repeatedly when the progress bar is inside the **red target zone** to catch the fish!</p>
        
        <div id="progress-bar-container">
            <div id="target-area"></div>
            <div id="progress-bar"></div>
        </div>

        <p id="minigame-feedback"></p>
        <button id="minigame-button">REEL!</button>
    </div>
</div>

<div id="bestiary-overlay" class="overlay">
    <div id="bestiary-box" class="overlay-box">
        <h3>üìö The Angler's Bestiary</h3>
        <p>Index of all known fish. Use the buttons below to filter by fishing location.</p>

        <div id="bestiary-map-selection"></div>

        <ul id="bestiary-list"></ul>
        <button style="background-color: #6c757d; margin-top: 15px;" onclick="closeBestiary()">Close Bestiary</button>
    </div>
</div>


<script>
    // --- Configuration: MAPS, RARITIES, FISH_NAMES, FISHING_RODS (Unchanged) ---
    const MAPS = [
        { id: 'lakeside', name: 'Lakeside Pier', description: 'A calm freshwater spot. Best for Common and Uncommon fish.' },
        { id: 'reef', name: 'Coral Reef', description: 'A vibrant marine habitat. Good for Rare and Epic fish.' },
        { id: 'deepsea', name: 'Deep Sea Trench', description: 'Dark, cold waters. Home to Legendary and Apex creatures.' }
    ];

    const RARITIES = [
        { name: 'Common', chance: 450, colorClass: 'rarity-common', baseValue: 8, maps: ['lakeside'] },
        { name: 'Uncommon', chance: 300, colorClass: 'rarity-uncommon', baseValue: 25, maps: ['lakeside', 'reef'] },
        { name: 'Rare', chance: 150, colorClass: 'rarity-rare', baseValue: 75, maps: ['lakeside', 'reef'] },
        { name: 'Epic', chance: 60, colorClass: 'rarity-orange', baseValue: 150, maps: ['reef'] }, 
        { name: 'Legendary', chance: 30, colorClass: 'rarity-legendary', baseValue: 350, maps: ['reef', 'deepsea'] },
        { name: 'Mythic', chance: 10, colorClass: 'rarity-mythic', baseValue: 800, maps: ['deepsea'] },
        { name: 'Exotic', chance: 5, colorClass: 'rarity-exotic', baseValue: 2500, maps: ['deepsea'] },
        { name: 'Secret', chance: 3, colorClass: 'rarity-secret', baseValue: 7500, maps: ['deepsea'] },
        { name: 'Apex', chance: 2, colorClass: 'rarity-apex', baseValue: 25000, maps: ['deepsea'] },
    ];
    
    const FISH_NAMES = {
        'Common': [ 'Minnow', 'Trout', 'Bass', 'Sardine', 'Guppy', 'Herring', 'Small Shrimp', 'Bluegill', 'Goby', 'Anchovy', 'Chub', 'Dace', 'Sunfish' ],
        'Uncommon': [ 'Perch', 'Carp', 'Catfish', 'Pike', 'Flounder', 'Mackerel', 'Red Snapper', 'Sockeye Salmon', 'Rockfish', 'Haddock', 'Wreckfish', 'Skipjack', 'Tilefish' ],
        'Rare': [ 'Salmon', 'Eel', 'Cod', 'Halibut', 'Tuna', 'Dorado', 'Grouper', 'Barracuda', 'Yellowfin Tuna', 'Striped Bass', 'Abalone', 'Flying Fish', 'Plaice' ],
        'Epic': [ 'Giant Squid', 'Wahoo', 'Marlin', 'Swordfish', 'King Salmon', 'Tiger Shark', 'Frilled Shark', 'Ocean Sunfish', 'Sailfish', 'Blue Shark', 'Giant Trevally' ],
        'Legendary': [ 'Mahi-Mahi', 'Kingfish', 'Bluefin Tuna', 'Goliath Grouper', 'Oarfish', 'Deep Sea Snapper', 'Vampire Squid', 'Saber-Toothed Viperfish', 'Coelacanth', 'Narwhal Fish' ],
        'Mythic': [ 'Kraken Trout', 'Sunken Shark', 'Phoenix Fish', 'Phantom Ray', 'Chrono Koi', 'Crystal Eel', 'Living Fossil', 'Astral Angler', 'Cosmic Ray', 'Shadow Leviathan' ],
        'Exotic': [ 'Abyssal Dragonfish', 'Volcanic Angler', 'Glitterfin Tetra', 'Cosmic Whalebone', 'Shadow Walker', 'Lava Cod', 'Aurora Borealis Fish', 'Galactic Glimmer' ],
        'Secret': [ 'Cosmic Jellyfish', 'jhawk1119', 'Void Traveler', 'The Deep One', 'The Developer', 'Ethereal Shade', 'The Silent One' ],
        'Apex': [ 'Primordial Leviathan', 'sioltt', 'Eternal Abyss Lord', 'Celestial Keeper', 'Ocean King', 'The World Eater', 'Apex Manta' ],
    };
    
    const FISHING_RODS = [
        { id: 'basic', name: 'Basic Rod', cost: 0, luck: 0, catchPowerMultiplier: 1.00 }, 
        { id: 'wood', name: 'Wooden Rod', cost: 100, luck: 5, catchPowerMultiplier: 1.15 }, 
        { id: 'steel', name: 'Steel Rod', cost: 500, luck: 10, catchPowerMultiplier: 1.30 }, 
        { id: 'carbon', name: 'Carbon Rod', cost: 2500, luck: 20, catchPowerMultiplier: 1.50 }, 
        { id: 'titanium', name: 'Titanium Rod', cost: 10000, luck: 40, catchPowerMultiplier: 1.80 }, 
        { id: 'casta', name: 'The Casta', cost: 15000, luck: 100, catchPowerMultiplier: 2.50 }, 
        { id: 'neptune', name: "Neptune's Trident", cost: 50000, luck: 250, catchPowerMultiplier: 3.50 },
        { id: 'aether', name: 'Aether Line', cost: 150000, luck: 500, catchPowerMultiplier: 5.00 },
        { id: 'void', name: 'Void Weave', cost: 500000, luck: 1200, catchPowerMultiplier: 7.50 },
        { id: 'cosmic', name: 'Cosmic Thread', cost: 1500000, luck: 3000, catchPowerMultiplier: 10.00 },
        { id: 'omega', name: 'The Omega', cost: 5000000, luck: 7500, catchPowerMultiplier: 15.00 }, 
    ];

    // --- State Variables ---
    let money = 0; 
    let currentRod = FISHING_RODS[0];
    let ownedRods = new Set(['basic']);
    let inventory = []; 
    let minigameActive = false;
    let minigameInterval;
    let currentFishRarity = null;
    let currentMapId = 'lakeside'; 
    let mapCooldown = false; 
    let mapChangeTimer = 0;
    let mapChangeInterval;
    const MAP_COOLDOWN_TIME = 10; 
    let discoveredFish = new Set();
    
    // --- PROFILE / SAVE SYSTEM VARIABLES ---
    const PROFILE_KEY = 'fishingGameProfiles';
    let currentProfile = null;
    let autoSaveInterval;
    
    // --- DOM Elements ---
    const fishingButton = document.getElementById('fishing-button');
    const sellAllButton = document.getElementById('sell-all-button');
    const resultDiv = document.getElementById('result');
    const fishList = document.getElementById('fish-list');
    const minigameOverlay = document.getElementById('minigame-overlay');
    const minigameButton = document.getElementById('minigame-button');
    // Elements specific to the moving bar minigame
    const progressBar = document.getElementById('progress-bar');
    const targetArea = document.getElementById('target-area');
    const minigameFeedback = document.getElementById('minigame-feedback');
    // End minigame elements
    const moneyDisplay = document.getElementById('money-display'); 
    const rodNameSpan = document.getElementById('rod-name'); 
    const rodLuckSpan = document.getElementById('rod-luck'); 
    const rodCatchPowerSpan = document.getElementById('rod-catch-power'); 
    const currentMapDisplay = document.getElementById('map-name');
    const mapButtonsContainer = document.getElementById('map-buttons-container');
    const bestiaryList = document.getElementById('bestiary-list');
    const bestiaryMapSelection = document.getElementById('bestiary-map-selection');
    const profileOverlay = document.getElementById('profile-overlay');
    const gameContainer = document.getElementById('game-container');
    const usernameInput = document.getElementById('username-input');
    const passwordInput = document.getElementById('password-input');
    const profileMessage = document.getElementById('profile-message');
    const currentProfileDisplay = document.getElementById('current-profile-display');

    // --- Minigame Variables ---
    let progress = 0;
    let barDirection = 1;
    const CONSTANT_BAR_SPEED = 2.5; 
    const REEL_INCREMENT = 5; 
    const CATCH_THRESHOLD = 100;
    

    // =================================================================
    // >>> PROFILE & AUTHENTICATION FUNCTIONS (UNCHANGED) <<<
    // =================================================================

    function getProfiles() {
        const profilesJson = localStorage.getItem(PROFILE_KEY);
        return profilesJson ? JSON.parse(profilesJson) : {};
    }

    function saveProfiles(profiles) {
        localStorage.setItem(PROFILE_KEY, JSON.stringify(profiles));
    }
    
    function checkProfileOnLoad() {
        clearInterval(autoSaveInterval); 
        
        profileOverlay.style.display = 'flex';
        gameContainer.style.display = 'none';
        
        initialSetup(); 
    }

    function handleLogin() {
        const username = usernameInput.value.trim();
        const password = passwordInput.value.trim();
        const profiles = getProfiles();
        
        profileMessage.style.color = 'red';

        if (!username || !password) {
            profileMessage.textContent = "Username and password cannot be empty.";
            return;
        }

        if (profiles[username] && profiles[username].password === password) {
            currentProfile = username;
            profileMessage.textContent = `Welcome back, ${username}! Loading game...`;
            profileOverlay.style.display = 'none';
            gameContainer.style.display = 'block';
            
            currentProfileDisplay.textContent = username;
            loadGame(true); 
            startAutoSave();
        } else {
            profileMessage.textContent = "Login failed. Invalid username or password.";
        }
    }

    function handleRegister() {
        const username = usernameInput.value.trim();
        const password = passwordInput.value.trim();
        const profiles = getProfiles();

        profileMessage.style.color = 'red';

        if (username.length < 3) {
            profileMessage.textContent = "Username must be at least 3 characters long.";
            return;
        }
        if (password.length < 4) {
            profileMessage.textContent = "Password must be at least 4 characters long.";
            return;
        }

        if (profiles[username]) {
            profileMessage.textContent = "Username already exists. Please log in or choose another name.";
        } else {
            profiles[username] = {
                password: password,
                gameState: null 
            };
            saveProfiles(profiles);
            
            currentProfile = username;
            profileMessage.style.color = 'green';
            profileMessage.textContent = `Account created! Welcome, ${username}! Starting new game...`;
            profileOverlay.style.display = 'none';
            gameContainer.style.display = 'block';
            
            currentProfileDisplay.textContent = username;
            resetGameState(); 
            startAutoSave();
        }
    }

    function logoutProfile() {
        if (confirm("Are you sure you want to log out? Ensure your progress is saved.")) {
            saveGame(); 
            clearInterval(autoSaveInterval);
            currentProfile = null;
            
            usernameInput.value = '';
            passwordInput.value = '';
            profileMessage.textContent = "Logged out successfully. Enter details to log back in.";
            profileMessage.style.color = 'green';
            
            profileOverlay.style.display = 'flex';
            gameContainer.style.display = 'none';
        }
    }

    // =================================================================
    // >>> SAVE/LOAD FUNCTIONS (UNCHANGED) <<<
    // =================================================================

    function getInitialGameState() {
         return {
            money: 0,
            currentRodId: FISHING_RODS[0].id,
            ownedRods: ['basic'],
            inventory: [],
            currentMapId: 'lakeside',
            discoveredFish: []
        };
    }

    function resetGameState() {
        const initialState = getInitialGameState();
        
        money = initialState.money;
        currentRod = FISHING_RODS[0];
        ownedRods = new Set(initialState.ownedRods);
        inventory = initialState.inventory;
        currentMapId = initialState.currentMapId;
        discoveredFish = new Set(initialState.discoveredFish);
        
        clearInterval(mapChangeInterval);
        mapCooldown = false;
        mapChangeTimer = 0;

        updateMoneyDisplay();
        updateRodDisplay();
        updateInventoryDisplay();
        setMap(currentMapId);
        toggleMapButtons(false);
        resultDiv.textContent = 'New game started!';
    }


    function saveGame() {
        if (!currentProfile) return;

        const profiles = getProfiles();
        if (!profiles[currentProfile]) return; 

        const gameState = {
            money: money,
            currentRodId: currentRod.id,
            ownedRods: Array.from(ownedRods),
            inventory: inventory,
            currentMapId: currentMapId,
            discoveredFish: Array.from(discoveredFish)
        };
        
        profiles[currentProfile].gameState = gameState;
        saveProfiles(profiles);
        // console.log(`Game Saved for profile: ${currentProfile}!`);
    }
    
    function startAutoSave() {
        clearInterval(autoSaveInterval); 
        autoSaveInterval = setInterval(() => {
            saveGame();
            console.log(`Auto-Saved profile: ${currentProfile}`);
        }, 10000); 
    }

    function loadGame(manualLoad = false) {
        if (!currentProfile) {
             if (manualLoad) resultDiv.textContent = 'Login first to load a profile!';
             return;
        }

        const profiles = getProfiles();
        const profileData = profiles[currentProfile];
        
        if (profileData && profileData.gameState) {
            const gameState = profileData.gameState;
            
            money = gameState.money || 0;
            currentRod = FISHING_RODS.find(r => r.id === gameState.currentRodId) || FISHING_RODS[0];
            ownedRods = new Set(gameState.ownedRods || ['basic']);
            inventory = gameState.inventory || [];
            currentMapId = gameState.currentMapId || 'lakeside';
            discoveredFish = new Set(gameState.discoveredFish || []);

            clearInterval(mapChangeInterval);
            mapCooldown = false;
            mapChangeTimer = 0;
            
            updateMoneyDisplay();
            updateRodDisplay();
            updateInventoryDisplay();
            generateMapButtons();
            setMap(currentMapId);
            toggleMapButtons(false);
            
            if (manualLoad) {
                resultDiv.textContent = `üîÅ Profile ${currentProfile} loaded successfully!`;
            } else {
                resultDiv.textContent = `Welcome back, ${currentProfile}. Game loaded.`;
            }
        } else {
            if (manualLoad) {
                resultDiv.textContent = `No save data found for ${currentProfile}. Starting new game.`;
            }
            resetGameState(); 
        }
    }
    
    function resetGame(confirmRequired = true) {
        if (!currentProfile) return;
        
        if (confirmRequired && !confirm(`Are you sure you want to reset all progress for profile "${currentProfile}"? This cannot be undone!`)) {
            return;
        }

        const profiles = getProfiles();
        if (profiles[currentProfile]) {
            profiles[currentProfile].gameState = null; 
            saveProfiles(profiles);
        }
        
        resetGameState();
        resultDiv.textContent = `üóëÔ∏è Profile progress for ${currentProfile} reset. Starting new game.`;
    }


    // =================================================================
    // >>> GAME LOGIC FUNCTIONS (MINIGAME MODIFIED) <<<
    // =================================================================
    
    function updateMoneyDisplay() {
        moneyDisplay.textContent = `üí∞ Money: $${money.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        updateShopDisplay(); 
        saveGame();
    }
    
    function updateRodDisplay() {
        rodNameSpan.textContent = currentRod.name;
        rodLuckSpan.textContent = currentRod.luck.toLocaleString(); 
        rodCatchPowerSpan.textContent = currentRod.catchPowerMultiplier.toFixed(2); 
        saveGame();
    }

    function getFishRarity() {
        const availableRarities = RARITIES.filter(r => r.maps.includes(currentMapId));
        const modifiedRarities = availableRarities.map(r => {
            let newChance = r.chance;
            if (r.name === 'Common') {
                newChance = r.chance - (currentRod.luck * 0.05);
                return { ...r, chance: Math.max(1, newChance) }; 
            } else if (r.name !== 'Uncommon') {
                newChance = r.chance + (currentRod.luck / 10);
                return { ...r, chance: newChance };
            }
            return r; 
        });

        const totalChance = modifiedRarities.reduce((sum, item) => sum + item.chance, 0);
        let random = Math.random() * totalChance;

        for (const item of modifiedRarities) {
            if (random < item.chance) {
                return RARITIES.find(r => r.name === item.name); 
            }
            random -= item.chance;
        }
        return availableRarities[0]; 
    }

    function getFishName(rarityName) {
        const names = FISH_NAMES[rarityName];
        return names[Math.floor(Math.random() * names.length)];
    }

    function startFishing() {
        if (minigameActive) return;
        currentFishRarity = getFishRarity();
        resultDiv.textContent = 'A bite! Reel it in!';
        startMiniGame();
    }

    // --- MOVING BAR MINIGAME CORE LOGIC (UNCHANGED) ---
    function startMiniGame() {
        minigameActive = true;
        fishingButton.disabled = true; 
        minigameOverlay.style.display = 'flex';
        
        // Setup initial bar and target
        progressBar.style.width = '0%';
        progress = 30 + Math.random() * 40; 
        barDirection = 1;
        minigameFeedback.textContent = 'Keep the bar in the red zone!';

        // Target size and position based on rarity (Rarer fish = smaller/faster target)
        const rarityIndex = RARITIES.findIndex(r => r.name === currentFishRarity.name);
        const baseTargetSize = 25; 
        const targetSize = Math.max(10, baseTargetSize - (rarityIndex * 2)); 
        const targetPos = 10 + Math.random() * (100 - targetSize - 10);
        
        targetArea.style.width = `${targetSize}%`;
        targetArea.style.left = `${targetPos}%`;
        targetArea.targetLeft = targetPos;
        targetArea.targetRight = targetPos + targetSize;
        
        progressBar.catchProgress = 0;
        minigameInterval = setInterval(updateMiniGame, 50);
    }
    
    function updateMiniGame() {
        const rarityIndex = RARITIES.findIndex(r => r.name === currentFishRarity.name);
        // Speed slightly increases with rarity
        const speed = CONSTANT_BAR_SPEED + (rarityIndex * 0.3); 
        
        progress += speed * barDirection;
        if (progress >= 100 || progress <= 0) {
            barDirection *= -1; 
            progress = Math.max(0, Math.min(100, progress));
        }
        progressBar.style.width = `${progress}%`;
    }

    function reelAction() {
        if (!minigameActive) return;

        const currentProgress = progress; 
        const isTargeted = currentProgress >= targetArea.targetLeft && currentProgress <= targetArea.targetRight;

        if (isTargeted) {
            // Success: progress reel
            const actualProgressIncrease = REEL_INCREMENT * currentRod.catchPowerMultiplier;
            progressBar.catchProgress = (progressBar.catchProgress || 0) + actualProgressIncrease;
            minigameFeedback.textContent = `HIT! Progress: ${Math.min(100, progressBar.catchProgress.toFixed(0))}% (+${actualProgressIncrease.toFixed(1)})`;
            
            if (progressBar.catchProgress >= CATCH_THRESHOLD) {
                endMiniGame(true);
            }
        } else {
            // FAIL: Instant loss if clicked outside the target zone
            minigameFeedback.textContent = `MISS! The fish got away!`;
            endMiniGame(false); 
        }
    }
    // --- END MINIGAME CORE LOGIC ---


    function endMiniGame(success) {
        clearInterval(minigameInterval);
        minigameActive = false;
        minigameOverlay.style.display = 'none';

        fishingButton.textContent = 'Click to Fish!';
        fishingButton.disabled = false;
        
        delete progressBar.catchProgress;

        if (success) {
            const fishName = getFishName(currentFishRarity.name);
            const weightMultiplier = 0.8 + (Math.random() * 0.7); 
            const actualValue = currentFishRarity.baseValue * weightMultiplier;
            const weight = 1 + (weightMultiplier * 2) * currentFishRarity.baseValue * 0.005; 
            const valueClass = weightMultiplier > 1.25 ? 'value-high' : (weightMultiplier < 0.9 ? 'value-low' : '');

            const message = `You successfully caught a <span class="${currentFishRarity.colorClass}">${currentFishRarity.name} ${fishName}!</span> It weighs <strong class="${valueClass}">${weight.toFixed(2)}kg</strong> and is worth <strong class="${valueClass}">$${actualValue.toFixed(2)}</strong>!`;
            resultDiv.innerHTML = message;
            
            const uniqueFishId = `${currentFishRarity.name}:${fishName}`;
            discoveredFish.add(uniqueFishId);
            
            inventory.push({
                rarity: currentFishRarity.name,
                name: fishName,
                baseValue: currentFishRarity.baseValue,
                actualValue: actualValue,
                weight: weight,
                colorClass: currentFishRarity.colorClass
            });
            updateInventoryDisplay();
        } else {
            resultDiv.textContent = 'The fish got away! Try again.';
        }
        saveGame();
    }
    
    function updateInventoryDisplay() { 
        // Logic to update the inventory display (omitted for brevity)
    }
    function sellAllFish() { 
        // Logic to sell all fish (omitted for brevity)
    }
    function generateMapButtons() { 
        // Logic to generate map buttons (omitted for brevity)
    }
    function initiateMapChange(mapId) { 
        // Logic to initiate map change (omitted for brevity)
    }
    function toggleMapButtons(isDisabled) { 
        // Logic to toggle map buttons (omitted for brevity)
    }
    function updateMapButtonText(targetMapId) { 
        // Logic to update map button text (omitted for brevity)
    }
    function setMap(mapId) { 
        // Logic to set the current map (omitted for brevity)
    }
    function openBestiary() { 
        // Logic to open the bestiary (omitted for brevity)
    }
    function closeBestiary() { 
        // Logic to close the bestiary (omitted for brevity)
    }
    function updateBestiaryDisplay(filterMapId) { 
        // Logic to update the bestiary display (omitted for brevity)
    }
    function openShop() { 
        // Logic to open the shop (omitted for brevity)
    }
    function closeShop() { 
        // Logic to close the shop (omitted for brevity)
    }
    function updateShopDisplay() { 
        // Logic to update the shop display (omitted for brevity)
    }
    function buyRod(rodId, cost) { 
        // Logic to buy a rod (omitted for brevity)
    }
    function equipRod(rodId) { 
        // Logic to equip a rod (omitted for brevity)
    }
    // REMOVED: openAdminPanel()
    // REMOVED: closeAdminPanel()
    // REMOVED: addMoneyCheat()
    // REMOVED: generateAdminRodButtons()
    // REMOVED: giveRodCheat()

    // --- Event Listeners and Initial Setup (UNCHANGED except for admin) ---
    fishingButton.addEventListener('click', startFishing);
    minigameButton.addEventListener('click', reelAction);
    sellAllButton.addEventListener('click', sellAllFish);
    document.getElementById('shop-button').addEventListener('click', openShop);
    document.getElementById('bestiary-button').addEventListener('click', openBestiary);
    // REMOVED: document.getElementById('cheat-trigger-button').addEventListener('click', openAdminPanel);

    // Expose global functions for inline HTML (Admin cheats removed)
    window.saveGame = saveGame;
    window.loadGame = loadGame;
    window.resetGame = resetGame;
    window.openShop = openShop;
    window.closeShop = closeShop;
    window.buyRod = buyRod;
    window.equipRod = equipRod;
    window.closeBestiary = closeBestiary;
    window.updateBestiaryDisplay = updateBestiaryDisplay;
    window.initiateMapChange = initiateMapChange;
    
    window.handleLogin = handleLogin;
    window.handleRegister = handleRegister;
    window.logoutProfile = logoutProfile;
    window.checkProfileOnLoad = checkProfileOnLoad;


    function initialSetup() {
        generateMapButtons();
        setMap(currentMapId);
        updateRodDisplay();
        updateInventoryDisplay();
        toggleMapButtons(false);
    }
</script>

</body>
</html>
